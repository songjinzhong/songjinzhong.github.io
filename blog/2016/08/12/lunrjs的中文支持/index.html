<!doctype html><html lang="zh-cn"><head><meta http-equiv="Content-Type" content="text/html" charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="author" content="song"><meta name="description" content="我的建站路4：解决 lunr.js 的中文支持问题"><title>我的建站路4：解决 lunr.js 的中文支持问题 | 渔人</title><link rel="alternate" href="/blog/rss.xml" title="渔人"><link rel="shortcut icon" href="/images/favicon.ico"><link rel="stylesheet" href="/css/all.min.css"></head><body><div class="post"><h1 class="overview"><a href="/blog/rss.xml" class="web-feed" title="RSS订阅" target="_blank"></a> <i class="search-icon"></i> <a href="/">渔人</a> <font>» </font><a href="/blog">博客</a> <font>» </font><a href="/blog/archives">归档</a><div class="big-search"><i class="close-icon"></i><div class="search-container"><form class="search-form"><input class="search-input js-search-input" type="text" placeholder="请输入关键字"></form><div class="js-search-results"></div></div></div></h1><div class="post-info"><h1>我的建站路4：解决 lunr.js 的中文支持问题</h1><div class="author-info"><p class="author">作者:<a href="/">宋进忠</a></p><p class="date">时间: <span>2016/08/12</span></p><p class="cat-arc"><span>分类: <a href="/blog/categories/建站/">建站</a> </span><span>标签: <a href="/blog/tags/建站/">建站</a> / <a href="/blog/tags/JavaScript/">JavaScript</a> / <a href="/blog/tags/LunrJs/">LunrJs</a></span></p></div></div><div class="post-markdown"><p>之前已经说过了，还没有为博客添加搜索功能，实际上，这个功能早已经实现了，只是还存在bug，比如对中文的强烈不兼容（实际上只支持汉语拼音，就是你要搜索“问题”，要打“wen ti”，真尴尬）。</p><p><img class="img-mid" src="http://ww1.sinaimg.cn/mw690/e3dde130gw1f8hoek1ibnj20zk0mtdkx.jpg" alt="图片来源网上" title="图片来源于网络"></p><h3 id="安装搜索框"><a href="#安装搜索框" class="headerlink" title="安装搜索框"></a>安装搜索框</h3><p>决定还是把搜索框和菜单栏放到一起，效果也和菜单栏一样，这边呢使用了一个 Github 上开源的基于 Ghost 的搜索插件，名字叫做 GhostHunter，<a href="https://github.com/jamalneufeld/ghostHunter">地址在这。</a></p><p>使用方法很简单，在HTML中引入：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><code class="xml"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"js/jquery.ghostHunter.min.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span>

<span class="tag">&lt;<span class="name">form</span>&gt;</span>
	  <span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">"search-field"</span> /&gt;</span> //id为”search-field“
	  <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">value</span>=<span class="string">"search"</span>&gt;</span>
<span class="tag">&lt;/<span class="name">form</span>&gt;</span>
<span class="tag">&lt;<span class="name">section</span> <span class="attr">id</span>=<span class="string">"results"</span>&gt;</span><span class="tag">&lt;/<span class="name">section</span>&gt;</span>
//”results“为输出结果</code></pre></td></tr></table></figure><p>在另外一个 js 文件中用下面的方式调用：</p><figure class="highlight livescript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><code class="livescript">$(<span class="string">"<span class="subst">#search-field</span>"</span>).ghostHunter(&#123;
	  results   : <span class="string">"<span class="subst">#results</span>"</span>
&#125;);</code></pre></td></tr></table></figure><p>它还有很多的使用方法，具体可以参考 Github 上的说明。</p><p>这个库是基于 lunr.js ，最大的尴尬是不支持中文，之前在 Github 上看到一个支持中文的 lunr.js ，地址找不到了，这段时间研究了一下 lunr.js，发现了其中的不少奥秘。</p><h3 id="关于lunrjs"><a href="#关于lunrjs" class="headerlink" title="关于lunrjs"></a>关于lunrjs</h3><p>Lunr.js 是一个 JavaScript 搜索引擎，是JS前端框架，可以快速的搜索静态的HTML内容，非常适合单页或者是无数据库的Web网页应用搜索，可以实现简单的全文搜索。</p><p>现在的博客系统都支持 RSS 订阅，是 XML 格式的，lunr.js 刚好可以用在博客系统的搜索上面，是一个独立于博客系统的搜索插件。</p><p>它的优势在于可以减轻服务器的搜索负载，只需从服务器加载 RSS 数据，在本地实现搜索操作。lunr.js 没有外部依赖，只需一个支持的浏览器。<a href="http://lunrjs.com/">官网地址</a>。</p><p>在 html 中调用 lunr.js 或 lunr.min.js，然后使用方法如下：</p><figure class="highlight qml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><code class="qml"><span class="built_in">var</span> index = lunr(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;
	<span class="keyword">this</span>.field(<span class="string">'title'</span>, &#123;<span class="attribute">boost</span>: <span class="number">10</span>&#125;)
	<span class="keyword">this</span>.field(<span class="string">'body'</span>)
	<span class="keyword">this</span>.ref(<span class="string">'id'</span>)
&#125;)

index.add(&#123;
	<span class="attribute">id:</span><span class="string"> 1,
	title</span>: <span class="string">'Foo'</span>,
	<span class="attribute">body</span>: <span class="string">'Foo foo foo!'</span>
&#125;)
index.add(&#123;
	<span class="attribute">id:</span><span class="string"> 2,
	title</span>: <span class="string">'Bar'</span>,
	<span class="attribute">body</span>: <span class="string">'Bar bar bar!'</span>
&#125;)

index.search(<span class="string">'foo'</span>)</code></pre></td></tr></table></figure><p><code>this.field()</code>就是添加索引体，<code>id</code>表示索引 id ，就是我们在搜索的时候返回的 id 。<code>this.field()</code>有一个可选参数，<code>boost</code>的官方解释是 <strong>An optional boost param can be passed to affect how much tokens in this field rank in search results, by default the boost value is 1.</strong>翻译过来就是一个权重值，权重越大，搜索的等级就越高。</p><p>lunr.js 词分析器基于 Martin Porter’s 算法，这个算法具体是怎么分词的，看了半天我也没看懂，自己写了一个例子，通过 chrome 的调试，才算弄懂了，具体见下图：</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><code class="stylus">index.add(&#123;
	id: <span class="number">1</span>,
	title: <span class="string">'abc def'</span>,
	<span class="selector-tag">body</span>: <span class="string">'hijk lmnb'</span>
&#125;)
<span class="selector-tag">var</span> result=index.search(<span class="string">"abc"</span>)</code></pre></td></tr></table></figure><p>设置断点，调试，发现其实用于搜索的是个树结构，如下图：</p><p><img src="/content/images/2016/08/lunrjs1.PNG" alt=""></p><p>title 和 body 中共有三个词 abc、def和hijk，首字母开头是a、d、h，再看子节点，</p><p><img src="/content/images/2016/08/lunrjs2.png" alt=""></p><p>会顺着树杈走下去，<code>d-&gt;e-&gt;f</code>，根节点的 <code>ref=1</code>表示搜索结果的 id 为1，tf 是 score，值是通过函数 <code>tokenCount / fieldLength * field.boost</code>得到的，0.5*10=5。score 这个值的属性可以用来排名，比如搜索结果大于一条的时候，排名靠前的往往是值较大的。</p><p>看看<code>hijk</code>的值，为0.5：</p><p><img src="/content/images/2016/08/lunrjs4.png" alt=""></p><p>那么 lunrjs 的搜索应该就是利用树来搜索。</p><p>之前看了一篇 Github 上关于添加中文支持，就是加了下面这句话：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><code class="javascript">lunr.trimmer = <span class="function"><span class="keyword">function</span> (<span class="params">token</span>) </span>&#123;
<span class="comment">//check token is chinese then not replace	</span>
	<span class="keyword">if</span>(isChineseChar(token))&#123;
		<span class="keyword">return</span> token;
	&#125;
  <span class="keyword">return</span> token
	.replace(<span class="regexp">/^\W+/</span>, <span class="string">''</span>)
	.replace(<span class="regexp">/\W+$/</span>, <span class="string">''</span>)
&#125;

<span class="function"><span class="keyword">function</span> <span class="title">isChineseChar</span>(<span class="params">str</span>)</span>&#123;     
   <span class="keyword">var</span> reg = <span class="regexp">/[\u4E00-\u9FA5\uF900-\uFA2D]/</span>;  
   <span class="keyword">return</span> reg.test(str);  
&#125;</code></pre></td></tr></table></figure><p>trimmer 是用来对 tokens 进行过滤，把一些非字母替换掉，加入中文的判断，如果是中文，返回。</p><p>这里有一个问题，英文字母是按照空格来区分每一个单词的，而对于中文，一句话说完才会结束，即使加了这句话，要想正常使用，还是不行的。经过测试，会把“今天天气很好”当作一句话来处理。</p><p><strong>解决的办法有两个，加入分词，或者强行加入空格来区分每一个单词。</strong></p><p><strong>先介绍一下分词</strong>，由于博主先前研究生上课的时候，学习过一些大数据分析的算法，其中就有用中文分词算法来实现中文句子的分词，这是另一门艺术，给你推荐一个分词算法 <a href="http://technology.chtsai.org/mmseg/">MMSEG</a>，感兴趣的小伙伴可以去研究一下。</p><p>通过单步调试，先把 title 改成“go back home”，调试到 <code>lunr.tokenizer</code>函数的时候：</p><p><img src="/content/images/2016/08/lunrjs5.png" alt=""></p><p><code>return rs</code>已经由字符串变成处理好的数组，英文是根据空格来区分每个字母的，所有当我们把 title 换成“我想家了妈妈，我想回家”，结果如下：</p><p><img src="/content/images/2016/08/lunrjs7.png" alt=""></p><p>这里已经很明显了，由于中文没有分词，返回的数组是按照标点符号和空格来划分的，中文分词算法放到哪里，你也应该知道了：</p><p><img src="/content/images/2016/08/lunrjs8.png" alt=""></p><p>可以使用一个循环，处理数组的每一个元素，重新返回一个把中文分词的新数组。</p><p><strong>后来，我又发现了一种更简单的方法！！</strong></p><p>根本不需要调试把中文分词算法加到 lunr.js 中，如果 <strong>lunr.add</strong> 加入的词已经是中文分词分好的，比如下面例子：</p><figure class="highlight less"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><code class="less"><span class="comment">//之前的笨方法</span>
<span class="selector-tag">index</span><span class="selector-class">.add</span>(&#123;
	<span class="attribute">id</span>: <span class="number">1</span>,
	<span class="attribute">title</span>: <span class="string">'我想家了妈妈，我想回家'</span>,
	<span class="attribute">body</span>: <span class="string">''</span>
&#125;)
<span class="comment">//在 add 之前先用中文分词处理一下title</span>
<span class="selector-tag">index</span><span class="selector-class">.add</span>(&#123;
	<span class="attribute">id</span>: <span class="number">1</span>,
	<span class="attribute">title</span>: <span class="string">'我 想家 了 妈妈 我 想 回家'</span>,
	<span class="attribute">body</span>: <span class="string">''</span>
&#125;)</code></pre></td></tr></table></figure><p>是我之前太笨了，太年轻！</p><p><strong>介绍一下第二种方法吧</strong>，我正在使用的方法，其实呢，Ghost 博客在 RSS 中加入了 description 用来解释博客，我们可以在索引中将标题手动添加空格，或者一些特殊的标点符号（建议使用空格）。比如本文的 description 是“解决 lunrjs 中文 支持 问题”。</p><p>这样做的优点是，我们还可以加入一些有用的分词，即使分词和文本内容没有关系。例如这篇文章是用 JavaScript 写的，但是通过 JavaScript 是搜索不到的，可以在 description 中加入 JavaScript 这个标签。</p><p>不过，这种方法有个很大的缺点，就是当内容很多或不支持 description 时就不适用了。建议使用分词算法。</p></div><div class="pre-next clear"><div class="pre-page"><i class="pre-icon"></i> <a href="/blog/2016/08/13/进度条和统计汉字/">我的建站路5：增加进度条和统计汉字个数</a></div><div class="next-page"><a href="/blog/2016/08/07/为博客增加一些实用功能/">我的建站路3：为博客增加一些实用功能</a> <i class="next-icon"></i></div></div><div class="post-footer"><a href="/blog/rss.xml" class="post-feed" target="_black">Feed <i class="feed-icon"></i></a><h3>文档信息</h3><ul><li><span>版权声明：</span><span>自由转载-非商用-保持署名</span><a href="https://creativecommons.org/licenses/by-nc-nd/3.0/deed.zh">(创意共享3.0许可证)</a></li><li><span>发表日期：</span><span>2016-08-12 22:14:36</span></li><li><span>本文分类：</span><span> <a href="/blog/categories/建站/">建站</a></span></li><li><span>本文标签：</span><span> <a href="/blog/tags/建站/">建站</a> / <a href="/blog/tags/JavaScript/">JavaScript</a> / <a href="/blog/tags/LunrJs/">LunrJs</a></span></li><li><span>最后编辑：</span><span>2016-10-05 20:42:00</span></li><li><span>社交媒体：</span><span><a href="https://github.com/songjinzhong">GitHub<i class="github"></i></a><a href="http://weibo.com/3822969136">微博<i class="weibo"></i></a></span></li><li><span>分享文章：</span> <span><div class="ds-share" data-thread-key="blog/2016/08/12/lunrjs的中文支持/" data-title="我的建站路4：解决 lunr.js 的中文支持问题" data-images="" data-content="之前已经说过了，还没有为博客添加搜索功能，实际上，这个功能早已经实现了，只是还存在bug，比如对中文的强烈不兼容（实际上只支持汉语拼音，就是你要搜索“问题”，要打“wen ti”，真尴尬）。安装搜索框决定还是把搜索框和菜单栏放到一起，..." data-url="http://yuren.space/blog/2016/08/12/lunrjs的中文支持/"><div class="ds-share-inline"><ul class="ds-share-icons-16"><li><a class="ds-weibo" href="javascript:void(0);" data-service="weibo">微博</a></li><li><a class="ds-qzone" href="javascript:void(0);" data-service="qzone">QQ空间</a></li><li><a class="ds-wechat" href="javascript:void(0);" data-service="wechat">微信</a></li></ul><div class="ds-share-icons-more"></div></div></div></span></li></ul></div><div class="page-related"><h2>相关文章</h2><ul><li><span>2016.09.28</span><a href="/blog/2016/09/28/原型链/">JS 进阶之路 : 原型链</a><p>刚学习 JavsScript 的时候，感觉它有点混乱，以前接触 C++或 ...</p></li><li><span>2016.09.24</span><a href="/blog/2016/09/24/闭包/">JS 进阶之路 : 闭包</a><p>函数在 JavaScript 中是第一型对象，而闭包的使用使其变得非常灵活...</p></li><li><span>2016.09.11</span><a href="/blog/2016/09/11/深入理解函数的概念/">JS 进阶之路 : 深入理解函数的概念</a><p>之前一直觉得自己对 JavaScript 这门语言掌握的还可以，记得当初学...</p></li><li><span>2016.09.07</span><a href="/blog/2016/09/07/腾讯404公益页面/">腾讯404公益页面，你中招了吗</a><p>之前在别人的博客里看到了腾讯的 404 公益页面，感觉很不错，算是腾讯的良...</p></li></ul></div><div class="duoshuo-part" id="comments"><div class="ds-thread" data-thread-key="blog/2016/08/12/lunrjs的中文支持/" data-title="我的建站路4：解决 lunr.js 的中文支持问题" data-url="http://yuren.space/blog/2016/08/12/lunrjs的中文支持/"></div><style type="text/css">.ds-sync{white-space:normal}.ds-post{transition:all .3s!important}.ds-post:hover{transition:all .3s!important;border-radius:5px!important;background:#F3F3F3!important}#ds-thread #ds-reset .ds-comments{border-bottom:none;padding:15px 0}#ds-thread #ds-reset .ds-powered-by{display:none}.ds-thread .ds-loading{padding:20px 0;text-align:center;color:#AFAFAF;background-color:#EFEFEF;border-radius:5px;line-height:30px;font-style:15px}#ds-thread .ds-loading{display:none;height:0;visibility:hidden}#ds-thread #ds-reset .ds-comments{border-bottom:none}#ds-thread #ds-reset a:hover,.ds-like-panel{color:#999}#ds-reset .ds-avatar,#ds-reset .ds-avatar img{border-radius:100%}#ds-thread #ds-reset li.ds-post{border-top:none}div#ds-thread #ds-reset .ds-comment-body p{color:#000}#ds-thread #ds-reset .ds-comment-body a{color:#777!important}#ds-thread #ds-reset li.ds-tab a{text-shadow:none}#ds-thread #ds-reset .ds-sort a.ds-current,#ds-thread #ds-reset .ds-sort a:active{color:#e58c7c}#ds-thread #ds-reset .ds-post-self{border-top:none}.ds-thread-like-text{display:block}.ds-thread-cancel-like{display:none}.ds-thread-liked .ds-thread-like-text{display:none}.ds-thread-liked .ds-thread-cancel-like{display:block}#ds-thread #ds-reset img{transition:all .3s}#ds-thread #ds-reset img:hover{transform:rotate(180deg);transition:all .3s}div#ds-thread #ds-reset .ds-comment-body{color:#555}#ds-thread #ds-reset .ds-comment-body a[data-user-id='6314610027441160961']::after{content:"博主";border:1px solid #e58c7c;border-radius:2px;margin-left:4px;color:#e58c7c;padding:0 2px;font-size:12px;line-height:14px;display:inline-block}.ds-post-reply,.ds-post-repost{display:none}.ds-post-self:hover .ds-post-reply,.ds-post-self:hover .ds-post-repost{display:inline}.ds-user-name{font-size:14px!important;line-height:42px!important}.ds-children .ds-user-name{line-height:26px!important}div#ds-thread #ds-reset .ds-comment-body p{font-size:16px!important}div#ds-thread #ds-reset .ds-comment-header .ds-user-name{font-size:18px!important;font-family:consolas!important;line-height:30px!important}div#ds-thread #ds-reset .ds-textarea-wrapper textarea{height:120px!important;font-size:16px!important;font-family:Consolas,Georgia,serif}@media (max-width:800px){div#ds-thread #ds-reset .ds-textarea-wrapper textarea{height:70px!important}}div#ds-thread #ds-reset .ds-post-options{overflow:hidden}div#ds-thread #ds-reset .ds-post-toolbar{box-shadow:none}div#ds-thread #ds-reset .ds-post-button{position:relative;margin-top:20px;font-size:16px}div#ds-thread #ds-reset .ds-post-options{margin-right:0!important;border-right:1px solid #CCC}@media screen and (max-width:641px){div#ds-thread #ds-reset .ds-replybox{padding:0!important}div#ds-thread #ds-reset .ds-replybox .ds-avatar{display:none!important}.ds-post-self:hover .ds-post-reply,.ds-post-self:hover .ds-post-report,.ds-post-self:hover .ds-post-repost{display:none!important}}div#ds-thread #ds-reset .ds-comment-body p{white-space:pre-wrap;font-family:consolas!important}#ds-thread #ds-reset .ds-paginator a{font-size:20px!important}#ds-thread #ds-reset .ds-login-buttons p{color:#999}#ds-thread #ds-reset .ds-comment-body{background:#fbfbfb;padding:15px 15px 12px 32px;border-radius:5px;box-shadow:0 1px 2px rgba(0,0,0,.15),0 1px 0 rgba(255,255,255,.75) inset}</style><script type="text/javascript">var duoshuoQuery={short_name:"songjz"};!function(){var t=document.createElement("script");t.type="text/javascript",t.async=!0,t.src=("https:"==document.location.protocol?"https:":"http:")+"//static.duoshuo.com/embed.js",t.charset="UTF-8",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(t)}()</script></div><div class="web-info">Copyright © 2016-2017,本站由 <a href="/blog/web-info">本人</a> 手工打造,历时2周, <a href="/blog/web-info/#link">联系方式</a> <span>网站参考 <a href="http://www.barretlee.com/">小胡子哥</a>/ <a href="http://www.ruanyifeng.com/home.html">阮一峰老师</a></span></div></div><div class="tools"><i class="back-to-top" style="display:none"></i> <i class="goto-comments"></i></div><script src="/js/jquery-3.1.0.min.js"></script><script src="/js/all.min.js"></script><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="//hm.baidu.com/hm.js?513bc3e28555252418b03cc8e660bc31";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><script>!function(e,t,a,n,c,o,s){e.GoogleAnalyticsObject=c,e[c]=e[c]||function(){(e[c].q=e[c].q||[]).push(arguments)},e[c].l=1*new Date,o=t.createElement(a),s=t.getElementsByTagName(a)[0],o.async=1,o.src=n,s.parentNode.insertBefore(o,s)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-85346637-1","auto"),ga("send","pageview")</script></body></html>