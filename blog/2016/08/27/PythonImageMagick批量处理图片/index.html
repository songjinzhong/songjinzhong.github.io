<!doctype html><html lang="zh-cn"><head><meta http-equiv="Content-Type" content="text/html" charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="author" content="song"><meta name="description" content="Windows Python ImageMagick 处理 图片"><title>Windows下用 Python + ImageMagick 批量处理图片 | 渔人</title><link rel="alternate" href="/blog/rss.xml" title="渔人"><link rel="shortcut icon" href="/images/favicon.ico"><link rel="stylesheet" href="/css/all.min.css"></head><body><div class="post"><h1 class="overview"><a href="/blog/rss.xml" class="web-feed" title="RSS订阅" target="_blank"></a> <i class="search-icon"></i> <a href="/">渔人</a> <font>» </font><a href="/blog">博客</a> <font>» </font><a href="/blog/archives">归档</a><div class="big-search"><i class="close-icon"></i><div class="search-container"><form class="search-form"><input class="search-input js-search-input" type="text" placeholder="请输入关键字"></form><div class="js-search-results"></div></div></div></h1><div class="post-info"><h1>Windows下用 Python + ImageMagick 批量处理图片</h1><div class="author-info"><p class="author">作者:<a href="/">宋进忠</a></p><p class="date">时间: <span>2016/08/27</span></p><p class="cat-arc"><span>分类: <a href="/blog/categories/图片处理/">图片处理</a> </span><span>标签: <a href="/blog/tags/Python/">Python</a> / <a href="/blog/tags/图片处理/">图片处理</a> / <a href="/blog/tags/ImageMagick/">ImageMagick</a></span></p></div></div><div class="post-markdown"><p>这周研究漏洞时，看了一下关于 ImageMagick 的漏洞，它是远程代码执行漏洞，远程攻击者利用漏洞通过上传恶意构造的图像文件，可在目标服务器执行任意代码，进而获得网站服务器的控制权。</p><p><img class="img-mid" src="http://ww4.sinaimg.cn/mw690/e3dde130gw1f8hqsr6xakj20zk0np18i.jpg" alt="图片来源网上" title="图片来源于网络"></p><p>当然，漏洞不是今天讨论的重点，ImageMagick 作为一个开源的图像处理软件，受到广大前端爱好者的喜爱，肯定有其原因的。我在之前只用过 PS 处理图片，根本就没听过 ImageMagick （<del>害羞</del>），研究的时候发现它小巧轻便，还能支持各种脚本（ C++、Python、Java等）批量处理图片，霸气度让觉得能甩 PS 两条街，对于程序员来说，它就是<strong>命令行上的 PhotoShop</strong>。</p><p>它的功能完全不逊 PS，支持和处理超过 90 种图片格式，功能包括格式转换、、变换、透明度、附加、装饰、特效、文本及评论、图像识别、综合、蒙太奇、电影支持、图像计算器、离散傅立叶变换、加密或解密图片、虚拟像素支持、大图像支持、执行、异构分布式处理…</p><p>关看到这些功能，估计你就眼花缭乱了吧！</p><p>今天就来研究一下它是如何用 Python 对图片批量处理的。</p><h3 id="关于安装"><a href="#关于安装" class="headerlink" title="关于安装"></a>关于安装</h3><p>我是在 windows 下安装的，它对 Linux 的支持更好，相对来说，Windows 下安装比较困难，要用 C 编译执行，但是由于官网推出了 .exe 的 Windows 安装文件之后，一切都变得很简单。</p><p><a href="http://www.imagemagick.org/script/binary-releases.php#windows">Windows 版本下载</a></p><p><del>是的，你没有看错，这个强大的软件只有 23MB。</del></p><p>在这里不建议下载最新版的，因为后面 Python 写脚本的时候，<code>最新版的暂时还支持不了 Wand 库</code>，可以从下面这个链接下载 6.9.5 ，</p><p><a href="http://www.imagemagick.org/download/binaries/">其他 Windows 版本下载</a></p><p><strong>特别注意</strong></p><p>无论你的系统是 64 位还是32 位，一定要看一下你的 Python 是多少位的，下载和 Python 相同位数的版本。比如，我的 Python 是 32 位的，我下载的版本是<code>ImageMagick-6.9.5-7-Q16-x86</code>，不然在后面用 Python 调用 ImageMagick 库的时候，会提示找不到路径的。</p><p>比如下面这个错误 <code>MagickWand shared library not found</code>：</p><p><img src="/content/images/2016/08/error.png" alt=""></p><p>安装，就直接下一步、下一步，注意下图：</p><p><img src="/content/images/2016/08/zhuyi.png" alt=""></p><p>把路径添加到环境变量里，同时要安装 libraries for C and C++。</p><h3 id="第一个-Hello-World"><a href="#第一个-Hello-World" class="headerlink" title="第一个 Hello World"></a>第一个 Hello World</h3><p>安装完成，需要测试一下，到安装目录下面，把 <code>convert.exe</code>改成<code>im_convert.exe</code>，因为<code>convert</code>这个命令和系统命令重复了…</p><p>打开命令行，运行：<code>im_convert nanjing.jpg -gravity southeast -fill white -pointsize 16 -draw &quot;text 5,5 &#39;Hello World&#39;&quot; nanjing_hw.jpg</code>，<strong>如果报错，说明环境变量没有配置好</strong>。</p><p>上面的命令就是执行把 nanjing.jpg 在距右下角（5px，5px）处打上字体白色 Hello World 水印，效果如下：</p><p><img src="/content/images/2016/08/test2.png" alt=""></p><h3 id="强如-Python-脚本"><a href="#强如-Python-脚本" class="headerlink" title="强如 Python 脚本"></a>强如 Python 脚本</h3><p>好啦，开始步入主题，用 Python 配合 ImageMagick 批量处理图。</p><p><strong>安装 Python 的支持库</strong></p><p><a href="http://www.imagemagick.org/script/api.php#python">从官方的文档来看</a>，Python 支持 3 个库，分别是 Wand、PythonMagick、PythonMagickWand：</p><p><img src="/content/images/2016/08/python.png" alt=""></p><p>这里我安装的是 <a href="http://docs.wand-py.org/en/0.4.3/">Wand</a>， 直接<code>pip install Wand</code>，当然也可以从 GitHub 上 <code>git clone git://github.com/dahlia/wand.git</code>。</p><p>安装好之后，用 <code>import wand</code>测试一下，不保错说明安装成功，</p><p>写了一个小测试：<br></p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><code class="python"><span class="keyword">from</span> wand.image <span class="keyword">import</span> Image
<span class="keyword">from</span> wand.display <span class="keyword">import</span> display

<span class="keyword">with</span> Image(filename=<span class="string">'nanjing.jpg'</span>) <span class="keyword">as</span> img:
    print(img.size)
    <span class="keyword">for</span> r <span class="keyword">in</span> <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>:
        <span class="keyword">with</span> img.clone() <span class="keyword">as</span> i:  <span class="comment"># 克隆图片</span>
            i.resize(int(i.width * r * <span class="number">0.25</span>), int(i.height * r * <span class="number">0.25</span>))
            i.rotate(<span class="number">90</span> * r)
            i.save(filename=<span class="string">'nanjing-&#123;0&#125;.jpg'</span>.format(r))  <span class="comment"># 保存图片</span></code></pre></td></tr></table></figure><p></p><p><img src="/content/images/2016/08/result.png" alt=""></p><p>上面用到了 <code>resize</code>：重新设置图片大小，<code>rotate</code>：图片旋转，<code>save</code>：保存图片。</p><p>如果报出了<code>MagickWand shared library not found</code>的错误，说明你的 Python 没有发现 ImageMagick 提供的接口，可能有以下原因：</p><ol><li>环境变量没配置好</li><li>你的 Python 是32位，你下载的 ImageMagick 是64 位</li><li>Wand 更新较慢，建议用 ImageMagick 稳定版而不是最新版（6.9.5是可用的）</li></ol><p>具体的错误还需要自己 Google，这只是我碰到的。</p><p>ImageMagick 的功能不止如此，这里只是列出了如何简单的使用，毕竟我才接触了两天，深入学习还是要花一定时间的，共勉！</p></div><div class="pre-next clear"><div class="pre-page"><i class="pre-icon"></i> <a href="/blog/2016/09/07/腾讯404公益页面/">腾讯404公益页面，你中招了吗</a></div><div class="next-page"><a href="/blog/2016/08/14/每天一道前端面试题（定期更新）/">每天一道前端面试题（定期更新）</a> <i class="next-icon"></i></div></div><div class="post-footer"><a href="/blog/rss.xml" class="post-feed" target="_black">Feed <i class="feed-icon"></i></a><h3>文档信息</h3><ul><li><span>版权声明：</span><span>自由转载-非商用-保持署名</span><a href="https://creativecommons.org/licenses/by-nc-nd/3.0/deed.zh">(创意共享3.0许可证)</a></li><li><span>发表日期：</span><span>2016-08-27 17:33:31</span></li><li><span>本文分类：</span><span> <a href="/blog/categories/图片处理/">图片处理</a></span></li><li><span>本文标签：</span><span> <a href="/blog/tags/Python/">Python</a> / <a href="/blog/tags/图片处理/">图片处理</a> / <a href="/blog/tags/ImageMagick/">ImageMagick</a></span></li><li><span>最后编辑：</span><span>2016-10-05 22:07:46</span></li><li><span>社交媒体：</span><span><a href="https://github.com/songjinzhong">GitHub<i class="github"></i></a><a href="http://weibo.com/3822969136">微博<i class="weibo"></i></a></span></li><li><span>分享文章：</span> <span><div class="ds-share" data-thread-key="blog/2016/08/27/PythonImageMagick批量处理图片/" data-title="Windows下用 Python + ImageMagick 批量处理图片" data-images="" data-content="这周研究漏洞时，看了一下关于 ImageMagick 的漏洞，它是远程代码执行漏洞，远程攻击者利用漏洞通过上传恶意构造的图像文件，可在目标服务器执行任意代码，进而获得网站服务器的控制权。当然，漏洞不是今天讨论的重点，ImageMagi..." data-url="http://yuren.space/blog/2016/08/27/PythonImageMagick批量处理图片/"><div class="ds-share-inline"><ul class="ds-share-icons-16"><li><a class="ds-weibo" href="javascript:void(0);" data-service="weibo">微博</a></li><li><a class="ds-qzone" href="javascript:void(0);" data-service="qzone">QQ空间</a></li><li><a class="ds-wechat" href="javascript:void(0);" data-service="wechat">微信</a></li></ul><div class="ds-share-icons-more"></div></div></div></span></li></ul></div><div class="page-related"><h2>相关文章</h2><ul><li><span>2016.07.31</span><a href="/blog/2016/07/31/python如何解决汉字编码问题/">Unicode Decode Error: python 如何解决汉字编码问题</a><p>由于项目需要，需要读取一个含有中文的txt文档，完了还要保存文件。文档之前...</p></li><li><span>2016.07.30</span><a href="/blog/2016/07/30/关于字符串和编码/">关于字符串和编码</a><p>字符编码上周用Python写代码的时候，再次遇到头疼的编码问题，读写文件的...</p></li></ul></div><div class="duoshuo-part" id="comments"><div class="ds-thread" data-thread-key="blog/2016/08/27/PythonImageMagick批量处理图片/" data-title="Windows下用 Python + ImageMagick 批量处理图片" data-url="http://yuren.space/blog/2016/08/27/PythonImageMagick批量处理图片/"></div><style type="text/css">.ds-sync{white-space:normal}.ds-post{transition:all .3s!important}.ds-post:hover{transition:all .3s!important;border-radius:5px!important;background:#F3F3F3!important}#ds-thread #ds-reset .ds-comments{border-bottom:none;padding:15px 0}#ds-thread #ds-reset .ds-powered-by{display:none}.ds-thread .ds-loading{padding:20px 0;text-align:center;color:#AFAFAF;background-color:#EFEFEF;border-radius:5px;line-height:30px;font-style:15px}#ds-thread .ds-loading{display:none;height:0;visibility:hidden}#ds-thread #ds-reset .ds-comments{border-bottom:none}#ds-thread #ds-reset a:hover,.ds-like-panel{color:#999}#ds-reset .ds-avatar,#ds-reset .ds-avatar img{border-radius:100%}#ds-thread #ds-reset li.ds-post{border-top:none}div#ds-thread #ds-reset .ds-comment-body p{color:#000}#ds-thread #ds-reset .ds-comment-body a{color:#777!important}#ds-thread #ds-reset li.ds-tab a{text-shadow:none}#ds-thread #ds-reset .ds-sort a.ds-current,#ds-thread #ds-reset .ds-sort a:active{color:#e58c7c}#ds-thread #ds-reset .ds-post-self{border-top:none}.ds-thread-like-text{display:block}.ds-thread-cancel-like{display:none}.ds-thread-liked .ds-thread-like-text{display:none}.ds-thread-liked .ds-thread-cancel-like{display:block}#ds-thread #ds-reset img{transition:all .3s}#ds-thread #ds-reset img:hover{transform:rotate(180deg);transition:all .3s}div#ds-thread #ds-reset .ds-comment-body{color:#555}#ds-thread #ds-reset .ds-comment-body a[data-user-id='6314610027441160961']::after{content:"博主";border:1px solid #e58c7c;border-radius:2px;margin-left:4px;color:#e58c7c;padding:0 2px;font-size:12px;line-height:14px;display:inline-block}.ds-post-reply,.ds-post-repost{display:none}.ds-post-self:hover .ds-post-reply,.ds-post-self:hover .ds-post-repost{display:inline}.ds-user-name{font-size:14px!important;line-height:42px!important}.ds-children .ds-user-name{line-height:26px!important}div#ds-thread #ds-reset .ds-comment-body p{font-size:16px!important}div#ds-thread #ds-reset .ds-comment-header .ds-user-name{font-size:18px!important;font-family:consolas!important;line-height:30px!important}div#ds-thread #ds-reset .ds-textarea-wrapper textarea{height:120px!important;font-size:16px!important;font-family:Consolas,Georgia,serif}@media (max-width:800px){div#ds-thread #ds-reset .ds-textarea-wrapper textarea{height:70px!important}}div#ds-thread #ds-reset .ds-post-options{overflow:hidden}div#ds-thread #ds-reset .ds-post-toolbar{box-shadow:none}div#ds-thread #ds-reset .ds-post-button{position:relative;margin-top:20px;font-size:16px}div#ds-thread #ds-reset .ds-post-options{margin-right:0!important;border-right:1px solid #CCC}@media screen and (max-width:641px){div#ds-thread #ds-reset .ds-replybox{padding:0!important}div#ds-thread #ds-reset .ds-replybox .ds-avatar{display:none!important}.ds-post-self:hover .ds-post-reply,.ds-post-self:hover .ds-post-report,.ds-post-self:hover .ds-post-repost{display:none!important}}div#ds-thread #ds-reset .ds-comment-body p{white-space:pre-wrap;font-family:consolas!important}#ds-thread #ds-reset .ds-paginator a{font-size:20px!important}#ds-thread #ds-reset .ds-login-buttons p{color:#999}#ds-thread #ds-reset .ds-comment-body{background:#fbfbfb;padding:15px 15px 12px 32px;border-radius:5px;box-shadow:0 1px 2px rgba(0,0,0,.15),0 1px 0 rgba(255,255,255,.75) inset}</style><script type="text/javascript">var duoshuoQuery={short_name:"songjz"};!function(){var t=document.createElement("script");t.type="text/javascript",t.async=!0,t.src=("https:"==document.location.protocol?"https:":"http:")+"//static.duoshuo.com/embed.js",t.charset="UTF-8",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(t)}()</script></div><div class="web-info">Copyright © 2016-2017,本站由 <a href="/blog/web-info">本人</a> 手工打造,历时2周, <a href="/blog/web-info/#link">联系方式</a> <span>网站参考 <a href="http://www.barretlee.com/">小胡子哥</a>/ <a href="http://www.ruanyifeng.com/home.html">阮一峰老师</a></span></div></div><div class="tools"><i class="back-to-top" style="display:none"></i> <i class="goto-comments"></i></div><script src="/js/jquery-3.1.0.min.js"></script><script src="/js/all.min.js"></script><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="//hm.baidu.com/hm.js?513bc3e28555252418b03cc8e660bc31";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><script>!function(e,t,a,n,c,o,s){e.GoogleAnalyticsObject=c,e[c]=e[c]||function(){(e[c].q=e[c].q||[]).push(arguments)},e[c].l=1*new Date,o=t.createElement(a),s=t.getElementsByTagName(a)[0],o.async=1,o.src=n,s.parentNode.insertBefore(o,s)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-85346637-1","auto"),ga("send","pageview")</script></body></html>